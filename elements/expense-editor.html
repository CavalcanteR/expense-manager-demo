<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="receipt-display.html">
<link rel="import" href="../scripts/accounting-js.html">
<link rel="import" href="../scripts/moment-js.html">

<dom-module id="expense-editor">
  <template>
    <style>
      #dialog {
        display: block;
        padding: 16px 32px 64px 32px;
        border: 1px solid #ccc;
        position: absolute;
        top: 0;
        margin: 0;
        width: 80vw;
        background: var(--primary-background-color);
        overflow-y: scroll;
      }

      .buttons-layout {
        margin-top: 16px;
      }

      .buttons-layout paper-button {
        width: 150px;
      }

      .save-button {
        background: var(--accent-color);
        color: var(--text-primary-color);
      }

      .cancel-button {
        color: var(--accent-color);
      }

      h2 {
        font-size: 2em;
        font-weight: 300;
      }

      .receipt {
        margin-left: 24px;
        min-height: 64px;
      }

      #error {
        color: red;
      }

      :host > .wrapper {
        height: 100%;
        width: 100%;
        padding: 0;
      }

      .close-button {
        color: var(--accent-color);
      }

      form ::content label {
        font-weight: bold !important;
        color: #999 !important;
      }

      @media (min-width: 900px) {
        .wrapper {
          @apply(--layout-horizontal);
        }
      }

      @media (max-width: 900px) {
        .receipt {
          margin: 24px 0 0 0;
        }

        .wrapper {
          @apply(--layout-vertical);
        }
      }

      @media (max-width: 600px) {
        #dialog {
          width: 100vw;
          min-height: 100vh;
          padding: 0;
        }
      }
    </style>
    <paper-dialog id="dialog" modal>
      <div class="layout horizontal">
        <h2>{{heading}}</h2>
        <span class="flex"></span>
        <paper-icon-button icon="close" on-tap="close"
                           class="close-button self-start"></paper-icon-button>
      </div>

      <div class="wrapper">
        <div class="form flex-2">
          <form is="iron-form" id="form">
            <iron-a11y-keys keys="enter" on-keys-pressed="_save"></iron-a11y-keys>
            <paper-input name="merchant" id="merchant" label="Merchant" auto-validate required
                         error-message="Merchant name required"></paper-input>
            <paper-input name="total" id="total" label="Total" auto-validate required
                         pattern="[\d,.]+"
                         error-message="Numeric values only">
              <div prefix>$</div>
            </paper-input>

            <paper-input label="Date" id="date" name="date" pattern="\d{4}-\d{2}-\d{2}"
                         error-message="Value must be in YYYY-MM-DD" auto-validate></paper-input>
            <paper-textarea id="comment" name="comment" label="Comment" value=""></paper-textarea>

            <input type="file" accept="image/jpeg" id="receiptupload" name="receipt"
                   capture="camera" hidden>
          </form>
          <span id="error">{{errorText}}</span>
        </div>
        <receipt-display id="preview" class="receipt flex-3"></receipt-display>
      </div>
      <div class="layout horizontal buttons-layout">
        <paper-button raised on-tap="_save" class="save-button">Save</paper-button>
        <paper-button on-tap="close" class="cancel-button">Cancel</paper-button>
        <paper-button on-tap="_delete" id="delete" class="delete-button right-justify">Delete
        </paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'expense-editor',

        properties: {
          service: Object,
          expense: {
            type: Object,
            notify: true,
            value: {}
          },
          heading: String,
          errorText: String
        },

        listeners: {
          'iron-form-invalid': '_showValidationErrors',
          'upload-requested': '_triggerUpload'
        },

        showReceipt: function(evt) {
          var _this = this;
          var input = evt.target;
          var preview = this.$.preview;

          if (input.files && input.files[0]) {
            var receipt = input.files[0];
            if (!receipt.type.match('image.*')) {
              return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
              preview.preview = receipt;
              _this.uploadDataURL = e.target.result;
            };
            reader.readAsDataURL(receipt);
          }
        },

        ready: function() {
          this.$.receiptupload.addEventListener('change', this.showReceipt.bind(this));
        },

        _reset: function() {
          this.errorText = '';
          if (this.expense.id) {
            this.heading = 'Edit Expense';

            this.$.preview.src = this.service.getReceiptURL(this.expense.id);

            // Need to set these manually as we need to update formats etc
            if (this.expense.merchant) {
              this.$.merchant.value = this.expense.merchant;
            }
            if (this.expense.total) {
              this.$.total.value = accounting.formatNumber(this.expense.total, 2);
            }
            if (this.expense.date) {
              this.$.date.value = moment(this.expense.date).format('YYYY-MM-DD');
            }
            if (this.expense.comment) {
              this.$.comment.value = this.expense.comment;
            }
            this.$.receiptupload.removeAttribute('required');
          } else {
            this.heading = 'Add Expense';
            this.$.preview.src = null;
            this.$.merchant.value = '';
            this.$.total.value = '';
            this.$.comment.value = '';
            this.$.date.value = moment().format('YYYY-MM-DD');
            this.$.receiptupload.setAttribute('required', true);
            this._resetValidationErrors();
          }
          this.$.delete.hidden = !(this.expense.id && this.expense.status === 'new');
        },

        _resetValidationErrors: function() {
          this.$.merchant.invalid = false;
          this.$.total.invalid = false;
        },

        _triggerUpload: function() {
          this.$.receiptupload.click();
        },

        _save: function() {
          var _this = this;
          this.$.error.innerText = '';
          var form = this.$.form;
          if (form.validate()) {
            // Sending raw serialized data too as FormData is read only. It's used for localstorage
            // if offline
            var rawData = form.serialize();
            rawData.receipt = _this.uploadDataURL;
            this.service.saveExpense(this.expense.id, new FormData(form), rawData)
              .then(function() {
                _this.fire('expenses-updated');
              })
              .catch(function(e) {
                console.log(e);
                _this.errorText = 'Save failed.';
              });
          } else {
            this.errorText = 'Please fill all required fields';
          }
        },

        _showValidationErrors: function(evt) {
          console.log(evt);
        },

        open: function() {
          this._reset();
          this.$.dialog.open();
        },

        close: function() {
          this.$.dialog.close();
        },

        _delete: function() {
          var _this = this;
          this.service.deleteExpense(this.expense.id).then(function() {
              _this.fire('expenses-updated', {reason: 'deleted'});
            })
            .catch(function(e) {
              console.log(e);
              _this.errorText = 'Delete failed.';
            });
        }
      });
    })();
  </script>
</dom-module>
